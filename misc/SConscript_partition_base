# -*- Mode: Python -*-

import sys
import os

from lxml import etree
import arinc653_xml_conf
import chpok_configuration
import template_generation

Import('env')

AddMethod(env, template_generation.TemplateRender)

def get_pok_partition_definitions(source, env):
    if type(source) is list:
        source = source[0]

    root = etree.parse(source.path)

    parser = arinc653_xml_conf.ArincConfigParser()

	conf = chpok_configuration.Configuration()
	parser.parse_partition(conf, root))

    return dict(conf=conf)


root = etree.parse(os.path.join(env['SCONSTRUCT_DIR'], env['xml']))
parser = arinc653_xml_conf.ArincConfigParser()
conf = chpok_configuration.Configuration()
conf.partitions.append(parser.parse_partition(root))

env.Command('clean_cmd', [], Delete('build/'))
env.Alias('clean', 'clean_cmd')

# this prevents config writing when we don't need to build
if not COMMAND_LINE_TARGETS and not env.GetOption('clean') and not env.GetOption('help'):
	if not os.path.exists(env['BUILD_DIR']):
		os.makedirs(env['BUILD_DIR'])
	# chpok_configuration.write_partition_configuration(conf, env['BUILD_DIR'], 0)
	
	env.TemplateRender(
        target = os.path.join(env['BUILD_DIR'], "deployment.c"),
        source = os.path.join(env['SCONSTRUCT_DIR'], env['xml']),
        create_definitions_func = get_pok_partition_definitions,
        template_main = "deployment_user",
        template_dir = env['POK_PATH'] + "/misc/templates"
        )


part_dir = os.path.join(env['SCONSTRUCT_DIR'], '')
part_build_dir = os.path.join(env['SCONSTRUCT_DIR'], env['BUILD_DIR'])
SConscript('SConscript_partition', exports = ['part_dir', 'part_build_dir'])

# EOF
