# -*- Mode: Python -*-

import sys
import os
import itertools

sys.path.insert(1, os.path.join(os.environ["POK_PATH"], "misc"))
import arinc653_xml_conf

import chpok_configuration
import xml.etree.ElementTree as ET

vars = Variables()
vars.AddVariables(
	('directory', 'directory', '.'),
	('xml', 'xml config to be passed to parser', 'config.xml'),
	('arch', 'architecture', 'ppc')
)

env = Environment(variables = vars, ENV = os.environ)

env['POK_PATH'] = os.environ['POK_PATH']
env['SCONSTRUCT_DIR'] = Dir('.').abspath
env['DEPLOYMENT_HEADER'] = 'kernel/deployment.h'

Export('env')

partition_dirs = (os.path.join(env['directory'], "pr%d" % i) for i in itertools.count(1))
partition_dirs = list(itertools.islice(partition_dirs, 255)) # XXX limited to 255 partitions right now
kernel_dir = os.path.join(env['directory'], "kernel")

root = ET.parse(env['xml'])

parser = arinc653_xml_conf.ArincConfigParser()
conf = parser.parse(root)

chpok_configuration.write_configuration(conf, kernel_dir, partition_dirs)

SConscript(env['POK_PATH']+'/misc/SConscript')

env.Command('run', [], env['QEMU']+env['QEMU_FLAGS'])
env.Ignore('.', 'run')

# EOF
