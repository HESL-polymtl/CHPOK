#Проектные данные. Подробное описание
Данные проекта указываются в файлах SConscript, хранящихся в проекте.

Эти SConscript-файлы считываются и интерпритируются системой сборки проекта, основанной на SCons.

Язык SConscript-файлов - Python (2й версии).

Данные проекта задаются используя *окружения Scons* (*Scons Environment*).

Различаются три типа окружения:

1. Окружение проекта в целом - `env`.
2. Окружение ядра - `kernel_env`.
3. Окружение раздела - `part_env`.

Окружение проекта обычно существует в единстенном экземпляре, и передается
SConscript'у проекта.

Окружение ядра обычно не используется явно, а создается системой сборки когда необходимо.

Окружение раздела существует отдельно для каждого раздела, и передается SConscript'у раздела.

Любое окружение можно клонировать:

    part_env_another = part_env.Clone()

после чего изменения окружения-клона не отражаются в окружении-оригинале.
Таким образом, разные компоненты раздела можно собирать в разных окружениях.

## Окружение проекта в целом

Это окружение передается файлу SConscript в директории проекта в качестве переменной с именем `env`.
Для того, чтобы работать с этой переменной, ее нужно импортировать:

    Import('env')

Определенные поля (ключи) окружения проекта имеют специальное значение при сборке проекта:

 - *PARTITIONS* - Обязательное для заполнения поле, содержащее список имен разделов.
 
    Пример:
    
        env['PARTITIONS'] = ['P1', 'P2']
    
    С каждым именем раздела связывается одноименная поддиректория в проекте.

 - *MODULE_XML* - Обязательное для заполнения поле, содержащее путь к файлу-конфигурации проекта.
 
    Пример:
    
        env['MODULE_XML'] = 'config.xml'
    
    Относительные пути считаются от директории проекта.
 
    Формат файла конфигурации описан в разделе [Конфигурация модуля](#конфигурация-модуля).

 - *CFLAGS* - строка с флагами компиляции для компонентов ядерного и пользовательского пространств.

    Новые флаги должны добавляться в конец строки после пробела.

    Пример:

        env['CFLAGS'] += ' -O3'

 - *CFLAGS_KERNEL* - строка с (дополнительными) флагами компиляции ядерных компонентов.
 
    Новые флаги должны добавляться в конец строки после пробела.

    Пример:

        env['CFLAGS_KERNEL'] += ' -O3'


 - *CFLAGS_USER* - строка с (дополнительными) флагами компиляции компонентов пользовательского пространства.
 
    Новые флаги должны добавляться в конец строки после пробела.

    Пример:

        env['CFLAGS_USER'] += ' -O3'


 - *QEMU_FLAGS* - строка с флагами для QEMU при запуске проекта.

    Новые флаги должны добавляться в конец строки после пробела.

    Пример:

        env['QEMU_FLAGS'] += ' -display none'

 - *KERNEL_TARGET* - файл с собранным ядром.
 
    Может устанавливаться только в результат вызова функции `kernel_env.BuildKernel()`.
    
    Если поле не установлено, то ядро собирается в сборочной поддиректории `kernel/` используя
    параметры `env`.
    
    Пример 1:
    
        env_another = env.Clone()
        env_another['CFLAGS'] += ' -O3'
        env['KERNEL_TARGET'] = env_another.BuildKernel()
    
    Этот код собирает ядро с флагами компиляции `-O3`, тогда как остальные компоненты модуля не используют эти флаги.
    Эквивалент `env['CFLAGS_KERNEL'] += ' -O3'`.
    
    Пример 2:
    
        env['KERNEL_TARGET'] = env.BuildKernel(variant_dir = <...>)
    
    Этот код собирает ядро в заданной директории.
    
    Если в другом проекте ядро также собирается в этой директории, то проекты могут переиспользовать этот компонент.
    При этом  надо следить, чтобы сборка ядра происходила с теми же параметрами (например, `CFLAGS`).

 - *BOARD_PHYS_SIZE* - размер оперативной памяти (RAM), доступной для модуля.
 
    Изначально, в этой переменной содержится размер оперативной памяти "по-умолчанию":
    
     - для неэмулируемых BSP: количество доступной памяти для SoC.
     - для эмулируемых BSP: значение по-умолчанию для QEMU (обычноб 128Мб).
    
    Для эмулируемых BSP значение этой переменной можно изменять произвольно: как увеличивать, так и уменьшать.
    
    Для неэмулируемых BSP значение этой переменной можно только уменьшать.
    Это будет означать, что модулю будет отводиться только часть доступной оперативной памяти (нижние адреса).

Информационные поля окружения проекта, которые могут читаться (но не меняться):

 - *ARCH* - архитектура, под которую собирается проект.
 
 - *BSP* - Board Support Package, с которым собирается проект.
 
 - *BOARD_IS_EMULATED* - истино, если BSP может запускаться на QEMU.
 
 - *BSP_PROPERTIES* - словарь (*dict*) свойств, определяемых для текущей BSP.
 
 - *BSP_PROPERTIES_FILE* - файл, содержащий свойства текущей BSP.
 
    Обычно используется как зависимость для создаваемых файлов, если эти файлы зависят от свойств BSP.

 - *MODULE_SOURCE_DIR* - директория проекта (абсолютный путь).
 
    Эта директория является текущей директорией при выполнении SConscript проекта.
    Таким образом, относительные пути в 'source' параметрах для команд SCons считаются от этой директории.
 
 - *MODULE_BUILD_DIR* - сборочная директория проекта. Сюда попадают файлы, создаваемые при сборке проекта.

    Сборочная директория находится внутри директории проекта с относительным путем `build/<bsp>/`.
    
    Эта директория является *variant_dir*, с которым исполняется SConscript проекта.
    Таким образом, относительные пути в 'target' параметрах для команд SCons считаются от этой директории автоматически.

## Окружение ядра
Окружение ядра создается из окружения проекта вызовом метода `KernelEnvironment()`:

    kernel_env = env.KernelEnvironment()
    
Окружение ядра наследует все поля-свойства окружения проекта, при этом содержимое поля *CFLAGS_KERNEL* уже добавлено к флагам компилятора *CFLAGS*.

С помощью окружения ядра можно компилировать файлы. Но нет способа добавить эти файлы к ядру модуля.

## Окружение раздела
Это окружение передается файлу SConscript в директории раздела в качестве переменной с именем `part_env`.
Для того, чтобы работать с этой переменной, ее нужно импортировать:

    Import('part_env')

Окружение раздела наследует все поля-свойства окружения проекта, при этом содержимое поля *CFLAGS_USER* уже добавлено к флагам компилятора *CFLAGS*.

С помощью этого окружения можно компилировать файлы для раздела. Результат компиляции можно добавить к разделу с помощью поля *PARTITION_SOURCES* (см. далее).

Дополнительно, определенные поля (ключи) этой переменной `part_env` имеют специальное значение при сборке раздела и проекта в целом:

 - *PARTITION_SOURCES* - Обязательное для заполнения поле, содержащее список файлов из которых будет собираться раздел.
 
    Файлы могут быть исходными файлами, объектными файлами или (статическими) библиотеками.

    Относительные пути считаются от директории раздела.

    Пример:

        part_env['PARTITION_SOURCES'] = ['src/main.c']
    
    Вместо пути к файлу может использоваться объект типа 'File', созданный в результате компиляции:
    
        // Компилирует файл 'my_obj.c'. Возвращает получившийся файл как список из одного объекта File().
        my_obj_targets = part_env.Object('my_obj.c') 
        // Добавляем объектный файл к разделу.
        part_env['PARTITION_SOURCES'] += my_obj_targets

 - *PARTITION_XML* - Обязательное для заполнения поле, содержащее файл конфигурации раздела.

    Пример:

        part_env['PARTITION_XML'] = 'config.xml'

    Относительные пути считаются от директории раздела.

    Формат файла описан в разделе [Конфигурация раздела](#конфигурация-раздела).

 - *CFLAGS* - строка с флагами компиляции раздела.

    Новые флаги должны добавляться в конец строки после пробела.

    Пример:

        part_env['CFLAGS'] += ' -O3'
    
 - *LIBJET_TARGET* - файл с собранной библиотекой *libjet*.
 
    Может устанавливаться только в результат вызова функции `part_env.BuildLibJet()`.
    
    Если поле не установлено, то библиотека собирается в сборочной поддиректории раздела `libjet/` используя
    параметры `part_env`.
    
    Пример 1:
    
        part_env_another = env.Clone()
        part_env_another['CFLAGS'] += ' -O3'
        part_env['LIBJET_TARGET'] = part_env_another.BuildLibJet()
    
    Этот код собирает *libjet* с флагами компиляции `-O3`, тогда как остальные компоненты раздела не используют эти флаги.
    
    Пример 2:
    
        part_env['LIBJET_TARGET'] = part_env.getSharedTarget('libjet', lambda: part_env.BuildLibJet(part_env['MODULE_BUILD_DIR'] + '/libjet')
    
    Этот код собирает *libjet* в сборочной директории *проекта* (точнее, в ее поддиректории `libjet/`).
    Этот же код может использоваться несколькими разделами проекта, при этом библиотека будет собираться только один раз.
    
    Смотри описание метода `SharedTarget()` ниже.

 - *SYSPART_TARGET* - файл с собранной библиотекой *syspart*.
 
    Может устанавливаться только в результат вызова функции `part_env.BuildSyspart()`.
    
    Если поле не установлено, то библиотека собирается в сборочной поддиректории раздела `syspart/` используя
    параметры `part_env`.
    
    Библиотека syspart используется для сборки раздела только если вызван метод окружения раздела `SystemPartition()`.
    
    Пример:
    
        part_env_another = env.Clone()
        part_env_another['CFLAGS'] += ' -O3'
        part_env['SYSPART_TARGET'] = part_env_another.BuildSyspart()
    
    Этот код собирает *syspart* с флагами компиляции `-O3`, тогда как остальные компоненты раздела не используют эти флаги.


Информационные поля окружения раздела, которые могут читаться (но не меняться):

 - *PARTITION_SOURCE_DIR* - директория раздела (абсолютный путь).
 
    Эта директория является текущей директорией при выполнении SConscript раздела.
    Таким образом, относительные пути в 'source' параметрах для команд SCons считаются от этой директории.
 
 - *PARTITION_BUILD_DIR* - сборочная директория раздела. Сюда попадают файлы, создаваемые при сборке раздела.

    Сборочная директория находится внутри директории раздела с относительным путем `build/<bsp>/`.
    
    Эта директория является *variant_dir*, с которым исполняется SConscript раздела.
    Таким образом, относительные пути в 'target' параметрах для команд SCons считаются от этой директории автоматически.

Методы окружения раздела:

 - `BuildLibJet(variant_dir = 'libjet')`

    Cобирает библиотеку *libjet*.
    
    Параметр `variant_dir` указывает на директорию, где производить сборку.
    По умолчанию, сборка выполняется в поддиректории сборки раздела `libjet`.

    Возвращаемое значение должно быть присвоено полю окружения *LIBJET_TARGET*.

 - `BuildSyspart(variant_dir = 'libjet')` 
 
    Cобирает библиотеку *syspart*.
    Параметр `variant_dir` указывает на директорию, где производить сборку.
    По умолчанию, сборка выполняется в поддиректории сборки раздела `syspart`.
 
    Возвращаемое значение должно быть присвоено полю окружения *SYSPART_TARGET*.

 - `SystemPartition()` 
 
    После вызова метода раздел отмечается как системный, для которого нужна библиотека *syspart*.
 
    Компиляция исходных файлов, использующих функциональность библиотеки, должна выполнятся после вызова этой функции.

 - `getSharedTarget(name, compute_val)`
 
    Метод использует словарь (*dict*), общий для всех окружений:
    один и тот же словарь используется окружением проекта, передаваемого в `SConscript` проекта, окружениями разделов,
    передаваемыми в `SConscript` разделов. Этот же словарь используется всеми окружениями, клонируемыми (методом `Clone()`) из вышеперечисленных окружений.
    
    Параметр `name` используется как имя ключа в этом словаре.
    
    Если значение для ключа не существует (или равно *None*), то выполняется функция `compute_val()` и ее результат присваивается значению ключа.
    
    Возвращает значение ключа (оригинальное, если оно существовало до вызова функции, или полученное после присваивания значения вызова функции `compute_val()`).
    
    Хотя семантика значений ключа может быть любой, основное предназначение функции - сборка общих для разделов компонентов только один раз.
    
    
