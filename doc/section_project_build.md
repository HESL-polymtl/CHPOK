# Работа с проектом
Работа с проектом осуществляется с помощью утилиты *scons*.

Для любой операции с проектом необходимо выбрать BSP (Board Support Package). BSP можно задать через *bsp* параметр `scons`:

    scons bsp=<bsp>

Также можно установить переменную окружения JETOS_BSP в нужное значение.

Дополнительно, с помощью переменных окружения для BSP можно переопределить определенные утилиты:

 - GDB — отладчик, который будет использован при отладке.
 - QEMU — эмулятор, в котором будет запускаться проект.
 - PREFIX — префикс, который будет присоединён к именам инструментов сборки, таких как ar, gcc, ld, objcopy, objdump и ranlib.

Список доступных BSP можно увидеть, выполнив команду `scons bsp=?`.
В настоящее время поддерживаются следующие BSP:

 - e500mc — PowerPC, для запуска в QEMU (в виртуальной машине используйте именно этот BSP);
 - e500_highmem — PowerPC, для запуска в QEMU, начиная с версии 2.3;
 - p3041 — PowerPC, для запуска на физическом устройстве.

## Сборка проекта
Сборка проекта осуществляется вызовом

    scons

из директории с проектом.

Результатом сборки будет ELF-файл `build/<bsp>/pok.elf`, содержащий весь модуль.

### Сборка отдельного раздела
Сборка раздела осуществляется вызовом

    scons

из директории с разделом.

Результатом сборки будет ELF-файл `build/<bsp>/part.elf`, содержащий раздел.

## Запуск проекта

### Запуск в QEMU
Для BSP эмулируемых в QEMU собранный проект может быть запущен на выполнение с помощью

    scons run

### Запуск с tap-устройством
Проект syspart-network-queue-nc нужно запускать командой scons run-tap.

### Запуск на физическом устройстве
####  Модуль с процессором p3041
Для запуска на физическом устройстве проект должен быть собран под BSP p3041.
После сборки загрузить на железе образ находящийся по пути *./build/p3041/pok.elf*.
Для этого нужно на инструментально машине развернуть tftp сервер. Поместить pok.elf на сервер.
Далее в uboot выполнить следующие команды:

    setenv ipaddr <IP адрес модуля>
    setenv serverip <IP адрес инструментальной машины с tftp сервером>
    tftpboot pok.elf
    bootelf


## Монитор
Во время работы проекта можно воспользоваться монитором, если он указан в [конфигурации системы](#конфигурация-системы).

Чтобы попасть в монитор, необходимо выполнить следующие действия:

 - Запустить систему командой `scons run`;
 - Нажать в окне терминала с запущенной системой клавишу Enter.
 
Чтобы увидеть список команд монитора, выполните команду *help*.

Выход из монитора осуществляется командой *exit*.

## Отладка с помощью GDB
Для запуска проекта в режиме отладки под GDB дополнительно указывается параметр *debug*:

    scons run debug=<debug-type>

После этого, в другом терминале можно запустить GDB:

    scons gdb

Поддерживается два типа отладки:

 1. Используя отладчик QEMU: `debug=qemu`
 2. Используя отладчик, встроенный в JetOS: `debug=jetos`

Отладчик QEMU находится на уровне "аппаратуры", поэтому с помощью этого отладчика можно отслеживать любую активность ОС.
Но этот отладчик не позволяет оперировать отдельными разделами и процессами в них.

Кроме того, этот отладчик недоступен для BSP, которые не эмулируются в QEMU.

Встроенный в JetOS отладчик позволяет оперировать отдельными разделами и процессами в них.
Но так как этот отладчик реализуется средствами самой операционной системы, то часть кода ОС недоступна для отладки.

### Возможности отладчика QEMU

При запуске отладки

    scons run debug=qemu

выполнение проекта приостанавливается на первой инструкции. Выполнение проекта может быть продолжено командой `c` в окне GDB.

Вначале доступна только отладочная информация ядра ОС.

Чтобы получить доступ к отладочной информации раздела, выполните в окне отладчика команду

    add-symbol-file <путь_к_ELF-файлу> 0x80001000
    
Например:

    add-symbol-file P1/build/e500mc/part.elf 0x80001000.
    
*Обратите внимание*: невозможно подключить данный отладчик более чем к одному разделу одновременно.
Таким образом, при попытке подключения нескольких разделов отладочная информация будет доступна только для раздела, подключенного последним.

### Возможности встроенного отладчика

По умолчанию, автоматической приостановки вначале выполнения проекта нет: проект выполняется как обычном режиме.

В любой момент выполнение проекта можно приостановить с помощью комбинации клавиш `Ctrl+C` в окне GDB.

Для автоматической приостановке вначале выполнения проект должен быть собран с флагом компилятора *POK_NEEDS_WAIT_FOR_GDB*.
Для такой сборки, добавьте в *SConscript* файл проекта строчку

    env['CFLAGS'] += ' -DPOK_NEEDS_WAIT_FOR_GDB'

*Внимание*: Собранный с флагом POK_NEEDS_WAIT_FOR_GDB проект работает только в режиме отладки. Для запуска в обычном режиме необходимо пересобрать проект без этого флага.

В отладчике реализована поддержка *inferiors*, каждый из которых связан с одним разделом. Первый *inferior* связан с ядром ОС.

Состояние разделов можно узнать с помощью GDB команды

    info inferiors

После команды GDB

    inferior <N>

последующие команды GDB будут связаны с указанным разделом.

*Внимание*: Команда GDB `inferior` не позволяет одному разделу выполняться вместо другого (т.е. расписание разделов не меняется).

Процессы разделов отображаются на абстракцию *threads* в GDB.
Например, узнать список созданных процессов во всех разделах можно с помощью команды GDB

    info threads

Пример вывода команды:

        Id   Target Id                     Frame
        30   Thread 1.27 (* P0 Stopped) pok_trap_addr ()
            at /home/freescale/work/chpok/kernel/arch/ppc/entry.S:424

Здесь *30* — номер процесса в клиентской части отладчика (именно его нужно указывать в команде `thread N`, чтобы переключиться на этот процесс).
*1.27* — это 27-й процесс системы, находящийся в 1-м разделе (в ядре системы).
В скобках после номера процесса находится информация о его состоянии (Stopped) и номере раздела (0), а символ '*' означает,
что именно на этом процессе произошло прерывание в системе и выполнение продолжится именно с него.
Раздел Frame показывает текущую функцию и файл, в котором эта функция находится.

После команды GDB

    thread <N>

последующие команды GDB будут связаны с указанным процессом.

*Внимание*: Команда GDB `thread` не позволяет одному процессу выполняться вместо другого (т.е. планирование процессов не меняется).

## Очистка проекта
Для очистки проекта, собранного под текущий *BSP*, выполните команду в директории проекта

    scons clean

Это приведёт к удалению следующих директорий:

 - build/&lt;bsp>
 - &lt;part>/build/&lt;bsp> для каждого раздела &lt;part> в проекте.

Команда `scons -c` удалит содержимое этих директорий, но не сами директории.


Для очистки проекта под все *BSP*, выполните команду

    scons distclean

Это приведёт к удалению следующих папок:

 - build
 - &lt;part>/build для каждого раздела &lt;part> в проекте.


*Внимание*: Для `scons distclean` по-прежнему необходимо задавать *BSP*.

### Очистка отдельного раздела

Для очистки раздела, собранного под текущий *BSP*, выполните команду в директории раздела

    scons clean

Это приведёт к удалению директории `build/&lt;bsp>`

Команда `scons -c` удалит содержимое этой директории, но оставит саму директорию.


Для очистки раздела под все *BSP*, выполните команду

    scons distclean

Это приведёт к удалению директории `build`.

*Внимание*: Для `scons distclean` по-прежнему необходимо задавать *BSP*.
