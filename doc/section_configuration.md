# Конфигурация системы
Конфигурация системы задаётся с помощью файлов xml. Файл конфигурации отдельного раздела находится в директории этого раздела. Имя этого файла указывается в *SConscript* раздела:

    part_xml = os.path.join(part_dir, 'config.xml')

Файл конфигурации системы находится в директории приложения. Имя этого файла указывается в SConstruct приложения:

    env['XML'] = os.path.join(Dir('.').abspath, 'config.xml')

## Конфигурация раздела

    <Definition Identifier="1" Name="P1" />

 - *Identifier* — идентификатор раздела, целое неотрицательное число;
 - *Name* — имя раздела, строка.
 
*Обратите внимание*: названия папок разделов и имена разделов в xml-конфигурации должны совпадать.

    <Memory Bytes="300K" />

Объём памяти, который будет предоставлен разделу. Допускаются следующие единицы измерения:

 - K — кило- (210);
 - M — мега- (220).

    <Threads Count="10" />

Количество процессов ARINC 653, которые могут быть созданы в данном разделе.
Обратите внимание: в это число не входят инициализационный процесс и Error Handler; инициализационный процесс существует всегда, а Error Handler всегда может быть создан.
Таким образом, указанное в конфигурационном файле число процессов будет фактически увеличено на два.

    <ARINC653_Buffers Data_Size="4096" Count="16" />
    
    <ARINC653_Blackboards Data_Size="4096" Count="16" />

    <ARINC653_Events Count="16" />

    <ARINC653_Semaphores Count="16" />
    
Различные структуры данных, описанные в ARINC 653.

 - *Count* — количество объектов определённого типа в данном разделе.
 - *Data_Size* (для буферов и досок сообщений) — максимальный размер одного сообщения для передачи.

    <ARINC653_Ports>

Порты данного раздела.

    <Queueing_Port Name="QP1" MaxMessageSize="64" Direction="DESTINATION" MaxNbMessage="10" />

 - *Name* — имя порта;
 - *MaxMessageSize* — максимальный размер одного сообщения;
 - *Direction* — направление передачи сообщений (допускаются значения DESTINATION и SOURCE);
 - *MaxNbMessage* (только для портов типа Queueing) — максимальное количество сообщений, которое может хранить порт.

    <Sampling_Port Name="SP1" MaxMessageSize="64" Direction="SOURCE" Refresh="1s" />

 - *Refresh* (только для портов типа *Sampling*) — период обновления. Допускаются следующие единицы измерения:

     - s — секунды;
     - ms — миллисекунды;
     - ns — наносекунды.

    Обратите внимание: указанное время не может составлять меньше, чем одну миллисекунду.

    <HM_Table>

Список ошибок и соответствующих им действий, которые будут предприняты системой в случае отсутствия процесса Error Handler для данного раздела.

    <Error Code="POK_ERROR_KIND_DEADLINE_MISSED" Level="PROCESS" ErrorCode="DEADLINE_MISSED" Action="COLD_START" />

 - *Code* — внутренний тип ошибки;
 - *Level* — уровень ошибки (может быть PROCESS или PARTITION);
 - *ErrorCode* — тип ошибки согласно ARINC 653;
 - *Action* — реакция на ошибку.

## Конфигурация системы

    <Partitions>
        <xi:include href="P1/config.xml" parse="xml"/>
        <xi:include href="P2/config.xml" parse="xml"/>
    </Partitions>
    
Подключение конфигурационных файлов разделов.

    <Schedule>

Расписание. Состоит из слотов (slots).

    <Slot Type="Partition" PartitionNameRef="P1" Duration="15ms" PeriodicProcessingStart="true" />

*Type* — тип слота. Допустимые значения:

 - *Spare* — пустой слот;
 - *Partition* — слот раздела;
 - *Monitor* — слот монитора.
 - *Duration* — период слота.

Доступно только для слотов разделов:

 - *PartitionNameRef* — имя раздела;
 - *PeriodicProcessingStart* — флаг, указывающий, является ли раздел периодическим (true или false). В настоящий момент данный флаг должен быть установлен в значение true.

Обратите внимание: первый слот в конфигурации должен быть слотом раздела.

Межпартиционные каналы:

Между тегами `<Connection_Table>` и `</Connection_Table>` перечисляют каналы:

    <Channel>
        <Source>
            <Standard_Partition PartitionName="P1" PortName="QP1" />
        </Source>
        <Destination>
            <Standard_Partition PartitionName="P2" PortName="UOUT" />
        </Destination>
    </Channel>

 - *Source* — порт-источник;
 - *Destination* — порт-приёмник.

Имя тега "Standard_Partition" является устаревшим, для системного раздела так же пишется Standard_Partition.

## Конфигурация системного раздела
Раздел помечается как системный добавлением атрибута `System="true"` в тег `Definition`:

    <Definition Identifier="1" Name="P1" System="true"/>

Порты описываются аналогично портам обычных разделов, но появляется дополнительный атрибут `Protocol="UDP"` (*UDP* — единственный поддерживаемый протокол на данный момент):

    <Queueing_Port Name="UIN"  Protocol="UDP" MaxMessageSize="64" Direction="SOURCE" MaxNbMessage="10" />

Остальная конфигурация производится в файле *depl.c*. В примере *syspart-network-queue-nc* файл находится в папке P2/.

Структура файла:

 - sys_queuing_channels — массив каналов. Здесь рассматриваются каналы между ARINC портами раздела и сетевыми портами (для UDP — пара ip-адрес и udp-порт). Структура канала:

     - .port_index — индекс порта в конфигурации данного раздела (нумеруются с нуля);
     - .driver_data — указатель на структуру данных, специфичную для драйвера канала;
     - .driver_ptr — указатель на  драйвер канала.

        данные, специфичные для драйвера канала. Например, ipnet_data_0, ipnet_data_1. Для сетевого стека, работающего с udp, содержат ip и port.
        Для SOURCE порта это адреса назначения. Для DESTINATION порта это адреса получения.

 - mac_addr_mapping — отображение ip в mac адреса;
 - channel_drivers — перечисление драйверов канала;
 - drivers_init — инициализирующая функция, описывающая, как драйверы нужно инициализировать;
 - pok_network_ip_address — ip-адрес данного модуля. Этот адрес будет использован в качестве *SOURCE* в отправляемых ip-пакетах.
