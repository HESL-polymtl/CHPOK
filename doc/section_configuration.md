# Конфигурация интеграционного проекта
Конфигурация интеграционного проекта задаётся с помощью файлов формата xml.

Конфигурационные файлы создаются для каждого раздела, а также для модуля в целом.

## Единицы измерения для атрибутов

По умолчанию, размер памяти указывается в байтах.
Используя суффиксы 'K' и 'M' (язык - английский), можно задавать размер в килобайтах и мегабайтах соответсвенно.
Следующие значения атрибутов размера памяти эквивалентны:

 - "2097152"
 - "2048K"
 - "2M"

По умолчанию, время измеряется в наносекундах.
Используя суффиксы 's', 'ms' можно задавать время в секундах и милисекундах соответственно.
Суффикс 'ns' не меняет смысла величины времени.

Следующие значения атрибутов продолжительности по времени эквивалентны:

 - "2000000000"
 - "2000000000ns"
 - "2000ms"
 - "2s"

## Конфигурация раздела

Файл конфигурации отдельного раздела находится в директории этого раздела. Имя этого файла указывается в *SConscript* раздела:

    part_env['PARTITION_XML'] = 'config.xml'

Конфигурационные параметры задаются внутри тэга 'Partition'.


### Список тэгов и атрибутов

Распознаются следующие тэги и их атрибуты:

 - *Definition* - идентификация раздела. Обязательный тэг.

    Пример:

        <Definition Identifier="1" Name="P1" />

    Атрибуты:

     - *Identifier* — идентификатор раздела, целое неотрицательное число. Обязательный атрибут.
     - *Name* — имя раздела, строка. Обязательный атрибут.

        *Обратите внимание*: названия папок разделов и имена разделов в xml-конфигурации должны совпадать.

     - *Period* - период раздела, время.

        Период раздела должен быть делителем продолжительности основного фрейма(major time frame).

        По-умолчанию, в качестве периода берется продолжительность основного фрейма.

     - *Duration* - продолжительность раздела за период, время.

        По-умолчанию, в качестве периода берется суммарная продолжительность всех окон раздела, деленная на отношение продолжительности основного фрейма к периоду раздела:

            duration = sum(partition-windows-durations) / (major-time-frame / partition-period)

 - *Memory* - требования раздела по памяти. Обязательный тэг.

    Пример:

        <Memory Bytes="300K" />

    Атрибуты:

     - *Bytes* - Объём памяти, который будет предоставлен разделу для его кода и данных. Обязательный атрибут.
     - *Heap* - Объем памяти, из которой выделяет память `smalloc()`.

 - *Threads* - требования раздела касающиеся потоков (в терминологии ARINC 653 - процессов). Обязательный тэг.

    Пример:

        <Threads Count="10" />

    Атрибуты:

     - *Count* - Количество процессов ARINC 653, которые могут быть созданы в данном разделе. Обязательный атрибут.

         *Обратите внимание*: число, указанное в атрибуте **не включает** инициализационный процесс и Error Handler.
         Инициализационный процесс существует всегда, а Error Handler всегда может быть создан.

         Таким образом, указанное в конфигурационном файле число процессов будет фактически увеличено на два.

 - *ARINC653_Buffers* - требования раздела, касающиеся буферов ARINC 653.

    Пример:

        <ARINC653_Buffers Count="16" Data_Size="4096"/>

    Атрибуты:

     - *Count* - максимальное количество буферов, которые может создать раздел. Обязательный атрибут.
     - *Data_Size* - размер памяти, отводимой на все сообщения во всех буферах. Обязательный атрибут.

         На каждое сообщение отводится количество памяти, равное максимальному размеру сообщения в буфере, округленное до 4 байт,
         плюс 4 байта на размер сообщения.

 - *ARINC653_Blackboards* - требования раздела касающиеся досок объявлений ARINC 653.

    Пример:

        <ARINC653_Blackboards Data_Size="4096" Count="16" />

    Атрибуты:

     - *Count* - максимальное количество досок объявлений, которые может создать раздел. Обязательный атрибут.
     - *Data_Size* - размер памяти, отводимой на сообщения во всех досках объявлений. Обязательный атрибут.

         На каждое сообщение отводится количество памяти, равное максимальному размеру сообщения в доске объявлений, округленное до 4 байт,
         плюс 4 байта на размер сообщения.

 - *ARINC653_Events* - требования раздела, касающиеся событий ARINC 653.

    Пример:

        <ARINC653_Events Count="16" />

    Атрибуты:

     - *Count* - максимальное количество объектов событий, которые может создать раздел. Обязательный атрибут.

 - *ARINC653_Semaphores* - требования раздела, касающиеся семафоров ARINC 653.

    Пример:

        <ARINC653_Semaphores Count="16" />

    Атрибуты:

     - *Count* - максимальное количество семафоров, которые может создать раздел. Обязательный атрибут.


 - *ARINC653_Ports* - Список портов данного раздела.

    Каждый порт задается соответствующим тэгом.

     - *Queueing_Port* - Описание queueing порта.

        Пример:

            <Queueing_Port Name="QP1" MaxMessageSize="64" Direction="DESTINATION" MaxNbMessage="10" />

        Атрибуты:

         - *Name* — имя порта. Обязательный атрибут.
         - *MaxMessageSize* — максимальный размер одного сообщения. Обязательный атрибут.
         - *Direction* — направление передачи сообщений (допускаются значения DESTINATION и SOURCE). Обязательный атрибут.
         - *MaxNbMessage* — максимальное количество сообщений, которое может хранить порт. Обязательный атрибут.

     - *Samling_Port* - описание sampling порта.

        Пример:

            <Sampling_Port Name="SP1" MaxMessageSize="64" Direction="SOURCE" Refresh="1s" />

        Атрибуты:

         - *Name* — имя порта. Обязательный атрибут.
         - *MaxMessageSize* — максимальный размер одного сообщения. Обязательный атрибут.
         - *Direction* — направление передачи сообщений (допускаются значения DESTINATION и SOURCE). Обязательный атрибут.
         - *Refresh* — период обновления. Обязательный атрибут.

            *Обратите внимание*: указанное время не может составлять меньше, чем одну миллисекунду.

 - *HM_Table* - таблица ошибок и реакции на них со стороны Health Monitor'а.

    По умолчанию, при любой ошибке раздел переходит в режим простаивания (*IDLE*).

     - *Error* - задание типа ошибки и реакции на ошибки такого рода.

        Пример:

            <Error Code="DEADLINE_MISSED" Level="PROCESS" ErrorCode="DEADLINE_MISSED" Action="COLD_START" />

        Атрибуты:

         - *Code* — внутренний тип ошибки. Обязательный атрибут.

            Возможные значения:

            - "MODPOSTPROCEVENT_ELIST"
            - "ILLEGAL_REQUEST"
            - "APPLICATION_ERROR"
            - "PARTLOAD_ERROR"
            - "NUMERIC_ERROR"
            - "MEMORY_VIOLATION"
            - "DEADLINE_MISSED"
            - "HARDWARE_FAULT"
            - "POWER_FAIL"
            - "STACK_OVERFLOW"
            - "PROCINIT_ERROR"
            - "NOMEMORY_PROCDATA"
            - "ASSERT"
            - "CONFIG_ERROR"
            - "CHECK_POOL"
            - "UNHANDLED_INT"

         - *Level* — уровень ошибки. Обязательный атрибут.

            Возможные значение:

            - "PROCESS"
            - "PARTITION"

         - *ErrorCode* — тип ошибки согласно ARINC 653. Обязательный атрибут для ошибки уровня *PROCESS*.

            Возможные значения(те же, что и для атрибута *Code*):

            - "MODPOSTPROCEVENT_ELIST"
            - "ILLEGAL_REQUEST"
            - "APPLICATION_ERROR"
            - "PARTLOAD_ERROR"
            - "NUMERIC_ERROR"
            - "MEMORY_VIOLATION"
            - "DEADLINE_MISSED"
            - "HARDWARE_FAULT"
            - "POWER_FAIL"
            - "STACK_OVERFLOW"
            - "PROCINIT_ERROR"
            - "NOMEMORY_PROCDATA"
            - "ASSERT"
            - "CONFIG_ERROR"
            - "CHECK_POOL"
            - "UNHANDLED_INT"

         - *Action* — реакция на ошибку. Обязательный атрибут.

            Возможные значения:

            - "IDLE" - раздел простаивает
            - "COLD_START" - раздел стартует в режиме COLD_START
            - "WARM_START" - раздел стартует в режиме WARM_START
            - "IGNORE" - ошибка игнорируется. Допустимо только для ошибок внутреннего типа "DEADLINE_MISSED".

 - *Memory_Blocks* - список блоков памяти для раздела.

     - *Memory_Block* - описание одного блока памяти для раздела.

        Пример:

            <Memory_Block Name="shared_mb0" Size="0x10000" Access="RW" CachePolicy="DEFAULT" InitSource="ZERO" InitStage="MODULE"/>

        Атрибуты:

         - *Name* - имя блока памяти. Обязательный атрибут.

             Имя должно быть уникально внутри раздела. Не использовать имена начинающиеся с точки ("."): эти имена зарезервированы для внутренних нужд.

         - *Size* - размер блока памяти. Обязательный атрибут.
         - *Access* - строка, описывающая права доступа раздела к блоку памяти. Обязательный атрибут.

            Допустимые символы строки:

            - 'R' - права на чтение
            - 'W' - права на запись
            - 'X' - права на исполнение кода

         - *Contiguous* - если равно "true", то блок памяти *физически непрерывен* (непрерывен в физической памяти).
            По умолчанию, гарантируется непрерывность блока только в виртуальной памяти.

         - *PhysicalAddress* - физический адрес блока памяти.
            Может использоваться только для специальных блоков памяти, связанных с физическими устройствами.
            (Иными словами, фиксировать физический адрес для блока памяти внутри RAM нельзя).

         - *CachePolicy* - политика кэширования доступа в блоку памяти. Обязательный атрибут.

            Возможные значения:

            - OFF - кэширование отключено
            - COPY_BACK
            - WRITE_THRU
            - OFF+COHERENCY
            - COPY_BACK+COHERENCY
            - WRITE_THRU+COHERENCY
            - OFF+GUARDED
            - COPY_BACK+GUARDED
            - WRITE_THRU+GUARDED
            - OFF+GUARDED+COHERENCY
            - COPY_BACK+GUARDED+COHERENCY
            - WRITE_THRU+GUARDED+COHERENCY
            - IO
            - DEFAULT - "обычная" политика кэширования, подходяшая в большинстве случаев.

         - *InitSource* - задает способ инициализации блока памяти. Обязательный атрибут если задан атрибут *InitStage*.

            Возможные значения:

            - "ZERO" - заполнение нулями.

         - *InitStage* - на каком этапе инициализируется блок памяти. Обязательный атрибут если задан атрибут *InitSource*.

            Возможные значения:

             - "MODULE" - блок памяти инициализируется при загрузке модуля.
             - "PARTITION" - блок памяти инициализируется при каждом старте раздела (в режиме COLD_START или WARM_START).
             - "PARTITION:COLD" - блок памяти инициализируется при каждом старте раздела в режиме COLD_START.

## Конфигурация модуля

Файл конфигурации системы находится в директории приложения. Имя этого файла указывается в SConstruct приложения:

    env['MODULE_XML'] = 'config.xml'

Конфигурационные параметры задаются внутри тэга 'MODULE'.

### Список тэгов и атрибутов

 - *Schedule* - расписание разделов в модуле. Обязательный тэг.

    Состоит из описания временных слотов (time slots).

     - *Slot* - описание временного слота.

        Пример:

            <Slot Type="Partition" PartitionNameRef="P1" Duration="15ms" PeriodicProcessingStart="true" />

        Атрибуты:

        - *Type* — тип слота. Обязательный атрибут.

            Возможные значения:

             - "Spare" — пустой слот
             - "Partition" — слот раздела
             - "Monitor" — слот монитора
             - "GDB" — слот отладчика

        - *Duration* — период слота. Обязательный атрибут.

        - *PartitionNameRef* — имя раздела. Только для слота типа "Partition". Обязательный атрибут.

        - *PeriodicProcessingStart* — флаг, указывающий, является ли раздел периодическим (true или false). Обязательный атрибут.

 - *Connection_Table* - список межпартиционных каналов.

     - *Channel* - описание межпартиционного канала. Связывает источник данных (*Source*) с приёмником (*Destination*).

        Пример:

            <Channel>
                <Source>
                    <Port_Ref PartitionNameRef="P1" PortNameRef="QP1" />
                </Source>
                <Destination>
                    <Port_Ref PartitionNameRef="P2" PortNameRef="UOUT" />
                </Destination>
            </Channel>

        На данный момент в качестве источника и приёмника данных канала могут выступать только порты ARINC653:

        - *Port_Ref* - ссылка на порт.

            Атрибуты:

            - PartitionNameRef - имя раздела-владельца порта. Обязательный атрибут.
            - PortNameRef - имя порта. Обязательный атрибут.

## TODO Конфигурация системного раздела
Раздел помечается как системный добавлением атрибута `System="true"` в тег `Definition`:

    <Definition Identifier="1" Name="P1" System="true"/>

Порты описываются аналогично портам обычных разделов, но появляется дополнительный атрибут `Protocol="UDP"` (*UDP* — единственный поддерживаемый протокол на данный момент):

    <Queueing_Port Name="UIN"  Protocol="UDP" MaxMessageSize="64" Direction="SOURCE" MaxNbMessage="10" />

Остальная конфигурация производится в файле *depl.c*. В примере *syspart-network-queue-nc* файл находится в папке P2/.

Структура файла:

 - sys_queuing_channels — массив каналов. Здесь рассматриваются каналы между ARINC портами раздела и сетевыми портами (для UDP — пара ip-адрес и udp-порт). Структура канала:

     - .port_index — индекс порта в конфигурации данного раздела (нумеруются с нуля);
     - .driver_data — указатель на структуру данных, специфичную для драйвера канала;
     - .driver_ptr — указатель на  драйвер канала.

        данные, специфичные для драйвера канала. Например, ipnet_data_0, ipnet_data_1. Для сетевого стека, работающего с udp, содержат ip и port.
        Для SOURCE порта это адреса назначения. Для DESTINATION порта это адреса получения.

 - mac_addr_mapping — отображение ip в mac адреса;
 - channel_drivers — перечисление драйверов канала;
 - drivers_init — инициализирующая функция, описывающая, как драйверы нужно инициализировать;
 - pok_network_ip_address — ip-адрес данного модуля. Этот адрес будет использован в качестве *SOURCE* в отправляемых ip-пакетах.
